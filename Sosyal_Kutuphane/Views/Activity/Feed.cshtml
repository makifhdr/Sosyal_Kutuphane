@model Sosyal_Kutuphane.Models.ViewModels.PagedFeedViewModel
@Html.AntiForgeryToken()

@{
    string DefaultAvatar = "/default-avatar.jpg";
    //AddComment ayarla
}


<h2 class="mt-3">Your Feed</h2>

@foreach (var a in Model.Activities)
{
    string avatar = a.Avatar != null
        ? $"data:image/png;base64,{Convert.ToBase64String(a.Avatar)}"
        : DefaultAvatar;

    <div class="card shadow-sm mt-4">
        <div class="card-body">

            <!-- HEADER -->
            <div class="d-flex align-items-center">
                <img src="@avatar" class="rounded-circle" width="50" height="50" />
                
                <div class="ms-3">
                    <a href="/Profile/Index/@a.UserId"
                       style="text-decoration:none; font-weight:bold;">
                        @a.UserName
                    </a>

                    <div class="text-muted small">
                        @if (a.ActivityType == "rating")
                        {
                            @:rated a @a.MediaType
                        }
                        else
                        {
                            @:reviewed a @a.MediaType
                        }

                        · @Sosyal_Kutuphane.Helpers.TimeAgo.Format(a.CreatedAt)
                    </div>
                </div>
            </div>

            <hr />

            <!-- BODY (Poster + Info) -->
            <div class="d-flex">

                <img src="@a.MediaPosterUrl"
                     width="120"
                     class="rounded me-3 shadow-sm" />

                <div>

                    <h5>
                        <a href="/Media/@(a.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@a.MediaId"
                           style="text-decoration:none;">
                            @a.MediaTitle
                        </a>
                    </h5>

                    <!-- RATING TYPE -->
                    @if (a.ActivityType == "rating")
                    {
                        <div class="mt-2">
                            <strong>Rating:</strong>
                            <span class="text-warning">

                                @{
                                    int score = a.RatingScore ?? 0;
                                    int stars = score / 2;
                                    int half = score % 2;
                                }

                                @for (int i = 0; i < stars; i++)
                                {
                                    @:★
                                }
                                @if (half == 1)
                                {
                                    @:☆
                                }

                            </span>
                            <span>(@a.RatingScore/10)</span>
                        </div>
                    }

                    <!-- REVIEW TYPE -->
                    @if (a.ActivityType == "review")
                    {
                        <p class="mt-2">
                            @a.ReviewExcerpt

                            <a href="/Media/@(a.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@a.MediaId#reviews">
                                more...
                            </a>
                        </p>
                    }

                </div>
            </div>

            <hr />

            <!-- FOOTER (Likes + Comments) -->
            <div>
                <button type="button"
                        class="btn btn-sm @(a.IsLiked ? "btn-danger text-white" : "btn-outline-primary") like-btn"
                        data-id="@a.ActivityId"
                        data-type="@a.ActivityType">
                    ❤️ Like (@a.LikeCount)
                </button>

                <a class="btn btn-outline-secondary btn-sm"
                   href="/Activity/AddComment?activityId=@a.ActivityId&activityType=@a.ActivityType">
                    💬 Comment (@a.CommentCount)
                </a>
            </div>
            
            <!-- COMMENTS SECTION -->
            @if (a.Comments?.Count > 0)
            {
                <div class="mt-3 ps-4 border-start">

                    @foreach (var c in a.Comments)
                    {
                        var avatarData = c.Avatar != null 
                            ? $"data:image/png;base64,{Convert.ToBase64String(c.Avatar)}"
                            : "/default-avatar.jpg";

                        <div class="d-flex mb-3">
                            <img src="@avatarData"
                                 width="50" height="50"
                                 class="rounded-circle border" />

                            <div class="ms-2">
                                <a href="/Profile/Index/@c.UserId"
                                   style="text-decoration:none;">
                                    <strong>@c.UserName</strong>
                                </a>

                                <div>@c.Content</div>

                                <small class="text-muted">
                                    @Sosyal_Kutuphane.Helpers.TimeAgo.Format(c.CreatedAt)
                                </small>
                                
                                <!-- Eğer giriş yapan kullanıcı bu yorumu yazdıysa "Delete" butonu -->
                                @if (User.Identity.IsAuthenticated &&
                                     int.Parse(User.FindFirst("UserId")!.Value) == c.UserId)
                                {
                                    <form method="post" asp-controller="Activity" asp-action="DeleteComment" class="mt-1">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <button class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@if (Model.HasNextPage)
{
    <div class="text-center mt-4">
        <a href="/Activity/Feed?page=@(Model.CurrentPage + 1)&pageSize=@Model.PageSize"
           class="btn btn-outline-primary">
            Load More
        </a>
    </div>
}
else
{
    <div class="text-center text-muted mt-3">
        No more activities.
    </div>
}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".like-btn").forEach(btn => {
            btn.addEventListener("click", () => {

                let activityId = btn.dataset.id;
                let type = btn.dataset.type;

                fetch("/Activity/ToggleLikeAjax", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken": document.querySelector("input[name='__RequestVerificationToken']").value
                    },
                    body: JSON.stringify({
                        activityId: activityId,
                        activityType: type
                    })
                })
                .then(res => res.json())
                .then(data => {

                    if (data.success) {
                        // Butonu güncelle
                        if (data.isLiked) {
                            btn.classList.remove("btn-outline-primary");
                            btn.classList.add("btn-danger", "text-white");
                        } else {
                            btn.classList.add("btn-outline-primary");
                            btn.classList.remove("btn-danger", "text-white");
                        }

                        btn.innerHTML = `❤️ Like (${data.likeCount})`;
                    }
                });
            });
        });
    });
</script>