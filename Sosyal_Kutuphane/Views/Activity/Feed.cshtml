@using Microsoft.IdentityModel.Tokens
@model Sosyal_Kutuphane.Models.ViewModels.PagedFeedViewModel
@Html.AntiForgeryToken()

@{
    string defaultAvatar = "/default-avatar.jpg";
}


<h2 class="mt-3">Your Feed</h2>

<div id="feed-loading" class="text-center my-4" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2">Loading...</div>
</div>

    @foreach (var a in Model.Activities)
    {
        string avatar = !a.Avatar.IsNullOrEmpty()
            ? $"data:image/png;base64,{Convert.ToBase64String(a.Avatar)}"
            : defaultAvatar;

        <div class="card shadow-sm mt-4">
            <div class="card-body">

                <div class="d-flex align-items-center">
                    <img src="@avatar" class="rounded-circle" width="50" height="50" 
                         alt="Image couldn't be displayed"/>

                    <div class="ms-3">
                        <a href="/Profile/Index/@a.UserId"
                           style="text-decoration:none; font-weight:bold;">
                            @a.UserName
                        </a>

                        <div class="text-muted small">
                            @if (a.ActivityType == "rating")
                            {
                                @:rated a @a.MediaType
                            }
                            else
                            {
                                @:reviewed a @a.MediaType
                            }

                            · @Sosyal_Kutuphane.Helpers.TimeAgo.Format(a.CreatedAt)
                        </div>
                    </div>
                </div>

                <hr/>

                <div class="d-flex">

                    <img src="@a.MediaPosterUrl"
                         width="120"
                         class="rounded me-3 shadow-sm"
                         alt="Image couldn't be displayed"/>

                    <div style="flex: 1; min-width: 0;">

                        <h5>
                            <a href="/Media/@(a.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@a.MediaId"
                               style="text-decoration:none;">
                                @a.MediaTitle
                            </a>
                        </h5>

                        @if (a.ActivityType == "rating")
                        {
                            <div class="mt-2">
                                <strong>Rating:</strong>
                                <span class="text-warning">

                                    @{
                                        int score = a.RatingScore ?? 0;
                                        int stars = score / 2;
                                        int half = score % 2;
                                    }

                                    @for (int i = 0; i < stars; i++)
                                    {
                                        @:★
                                    }
                                    @if (half == 1)
                                    {
                                        @:☆
                                    }

                                </span>
                                <span>(@a.RatingScore/10)</span>
                            </div>
                        }

                        @if (a.ActivityType == "review")
                        {
                            <p class="mt-2">
                                @a.ReviewExcerpt

                                @if (a.ReviewExcerpt.Length > 200)
                                {
                                    <a href="/Media/@(a.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@a.MediaId#reviews">
                                        read more...
                                    </a>
                                }
                            </p>
                        }

                    </div>
                </div>

                <hr/>

                <div>
                    <button type="button"
                            class="btn btn-sm @(a.IsLiked ? "btn-danger text-white" : "btn-outline-primary") like-btn"
                            data-id="@a.ActivityId"
                            data-type="@a.ActivityType">
                        ❤️ Like (@a.LikeCount)
                    </button>

                    <a class="btn btn-outline-secondary btn-sm"
                       href="/Activity/AddComment?activityId=@a.ActivityId&activityType=@a.ActivityType">
                        💬 Comment (@a.CommentCount)
                    </a>
                </div>

                @if (a.Comments.Count > 0)
                {
                    <div class="mt-3 ps-4 border-start">

                        @foreach (var c in a.Comments)
                        {
                            var avatarData = !c.Avatar.IsNullOrEmpty()
                                ? $"data:image/png;base64,{Convert.ToBase64String(c.Avatar)}"
                                : "/default-avatar.jpg";

                            <div class="d-flex mb-3">
                                <img src="@avatarData"
                                     width="50" height="50"
                                     class="rounded-circle border"
                                     alt="Image couldn't be displayed"/>

                                <div class="ms-2">
                                    <a href="/Profile/Index/@c.UserId"
                                       style="text-decoration:none;">
                                        <strong>@c.UserName</strong>
                                    </a>

                                    <div>@c.Content</div>

                                    <small class="text-muted">
                                        @Sosyal_Kutuphane.Helpers.TimeAgo.Format(c.CreatedAt)
                                    </small>

                                    @if (User.Identity is { IsAuthenticated: true } &&
                                         int.Parse(User.FindFirst("UserId").Value) == c.UserId)
                                    {
                                        <form method="post" asp-controller="Activity" asp-action="DeleteComment" class="mt-1">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@c.Id"/>
                                            <button class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    @if (Model.HasNextPage)
    {
        <div class="text-center mt-4">
            <a href="/Activity/Feed?page=@(Model.CurrentPage + 1)&pageSize=@Model.PageSize"
               class="btn btn-outline-primary">
                Load More
            </a>
        </div>
    }
    else
    {
        <div class="text-center text-muted mt-3">
            No more activities.
        </div>
    }

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".like-btn").forEach(btn => {
            btn.addEventListener("click", () => {

                let activityId = btn.dataset.id;
                let type = btn.dataset.type;

                fetch("/Activity/ToggleLikeAjax", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken": document.querySelector("input[name='__RequestVerificationToken']").value
                    },
                    body: JSON.stringify({
                        activityId: activityId,
                        activityType: type
                    })
                })
                .then(res => res.json())
                .then(data => {

                    if (data.success) {
                        if (data.isLiked) {
                            btn.classList.remove("btn-outline-primary");
                            btn.classList.add("btn-danger", "text-white");
                        } else {
                            btn.classList.add("btn-outline-primary");
                            btn.classList.remove("btn-danger", "text-white");
                        }

                        btn.innerHTML = `❤️ Like (${data.likeCount})`;
                    }
                });
            });
        });
    });
</script>

    <script>
document.addEventListener("DOMContentLoaded", function () {

    const loadingDiv = document.getElementById("feed-loading");

    loadingDiv.style.display = "block";

    window.addEventListener("load", () => {
        loadingDiv.style.display = "none";
    });

});
</script>