@using Sosyal_Kutuphane.Data
@model Newtonsoft.Json.Linq.JObject
@inject ApplicationDbContext _db

@{
    var durationMinutes = (int)@Model["runtime"];
    var durationString = durationMinutes/60 + " hours and " + durationMinutes%60 + " minutes";
    
    string mediaId = Model["id"]?.ToString() ?? "";
    string mediaType = "movie";

}

<h1>@Model["title"]</h1>

<div class="container mt-4">
    
    <div class="row">
        
        <div class="col-md-4">
            @{
                var poster = $"https://image.tmdb.org/t/p/w500{Model["poster_path"]}";
            }
            <img src="@poster" width="300" alt=""/>
        </div>
        
        <div class="col-md-8">
            
            <p>
    
                @Model["overview"]
            </p>
            
            @{
                var releaseYear = Model["release_date"].ToString() != "" ? 
                    Model["release_date"].ToString().Substring(0, 4) : 
                    "No information";
            }
            <p>
                <strong>Release Year:</strong> @releaseYear
            </p>
            
            <p>
                <strong>Duration:</strong> @durationString
            </p>
            
            <p>
                @{
                    var genres = Model["genres"].Count() != 0 ? 
                        string.Join(", ", @Model["genres"].Select(g => g["name"].ToString())) :
                        "No information";
                }
                <strong>Genres:</strong>
                @genres
            </p>
            @{
                var ratingList = _db.Ratings
                    .Where(r => r.MediaId == mediaId && r.MediaType == mediaType).ToList();
                int ratingSum = 0;

                double? ratingAverage = 0.0;

                if (!ratingList.IsNullOrEmpty())
                {
                    foreach (var rating in ratingList)
                    {
                        ratingSum += rating.Score;
                    }
                }

                if(ratingSum != 0) ratingAverage = ratingSum / (double)ratingList.Count;
    
                var userIdClaim = User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value;
                int? currentUser = userIdClaim != null ? int.Parse(userIdClaim) : null;

                int? userRating = null;

                if (currentUser != null)
                {
                    userRating = _db.Ratings
                        .Where(r => r.MediaId == mediaId && r.MediaType == mediaType && r.UserId == currentUser)
                        .Select(r => (int?)r.Score)
                        .FirstOrDefault();
                }
            }
            @if (ratingAverage != 0)
            {
                <p>
                    <strong>Average Rating:</strong> @ratingAverage/10 
                    <text class="text-muted"> (@ratingList.Count ratings) </text>
                </p>
            }
            
        </div>
        
    </div>
    
</div>


<h3>Director</h3>
@Model["credits"]?["crew"]!.FirstOrDefault(c => (string)c["job"]! == "Director")?["name"]

@{
    var model1 = (Model["credits"]?["cast"]!).Take(5);
    if (model1.ToList().Count != 0)
    {
        <h3>Actors</h3>
        <ul>
            @{
                foreach (var a in model1)
                {
                    <li>@a["name"] as @a["character"]</li>
                }
            }
        </ul>
    }
    else
    {
        <h3></h3>
    }
}

<!-- Library Buttons -->
@{
    int? userId = User.Identity.IsAuthenticated
        ? int.Parse(User.FindFirst("UserId").Value)
        : null;

    var userMedia = userId != null
        ? _db.UserMedia.FirstOrDefault(um => um.UserId == userId && um.MediaId == mediaId && um.MediaType == mediaType)
        : null;
}
            @if (User.Identity.IsAuthenticated)
            {
                <div>
                    <!-- Watched -->
                    @if (userMedia != null && userMedia.Status == "watched")
                    {
                        <form method="post" asp-controller="Media" asp-action="RemoveFromLibrary" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="mediaId" value="@mediaId" />
                            <input type="hidden" name="mediaType" value="@mediaType" />
                            <button class="btn btn-danger">Remove from 'Watched'</button>
                        </form>
                    }
                    else
                    {
                        <form method="post" asp-controller="Media" asp-action="AddToLibrary" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="mediaId" value="@mediaId" />
                            <input type="hidden" name="mediaType" value="@mediaType" />
                            <input type="hidden" name="status" value="watched" />
                            <button class="btn btn-success">Add to 'Watched'</button>
                        </form>
                    }

                    <!-- To Watch -->
                    @if (userMedia != null && userMedia.Status == "towatch")
                    {
                        <form method="post" asp-controller="Media" asp-action="RemoveFromLibrary" class="d-inline ms-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="mediaId" value="@mediaId" />
                            <input type="hidden" name="mediaType" value="@mediaType" />
                            <button class="btn btn-outline-danger">Remove from 'To Watch'</button>
                        </form>
                    }
                    else
                    {
                        <form method="post" asp-controller="Media" asp-action="AddToLibrary" class="d-inline ms-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="mediaId" value="@mediaId" />
                            <input type="hidden" name="mediaType" value="@mediaType" />
                            <input type="hidden" name="status" value="towatch" />
                            <button class="btn btn-outline-primary">Add to 'To Watch'</button>
                        </form>
                    }
                </div>

                <!-- Custom List Add -->
                <div class="mt-3">
                    <!-- Custom List Add -->
                    <div class="mt-3">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <a asp-controller="Media"
                               asp-action="AddToCustomListPage"
                               asp-route-mediaId="@mediaId"
                               asp-route-mediaType="@mediaType"
                               class="btn btn-outline-secondary mt-3">
                                Add to Custom List
                            </a>
                        }
                    </div>
                </div>
            }
            
            @if (userRating != null)
            {
                <p><strong>Your rating:</strong> @userRating/10</p>
            }
<form method="post" asp-controller="Activity" asp-action="Rate">
    <input type="hidden" name="mediaId" value="@Model["id"]" />
    <input type="hidden" name="mediaType" value="movie" />
                
    <label><strong>Give a new rating (1–10):</strong></label>
    <input type="number" name="score" min="1" max="10" class="form-control w-25" required />

    <button class="btn btn-primary mt-2">Submit Rating</button>
</form>

<form method="post" asp-controller="Activity" asp-action="AddReview" class="mt-4">
    <input type="hidden" name="mediaId" value="@Model["id"]" />
    <input type="hidden" name="mediaType" value="movie" /> <!-- veya book -->

    <label><strong>Your Review:</strong></label>
    <textarea name="content" class="form-control" rows="3" required></textarea>

    <button class="btn btn-success mt-2">Send Review</button>
</form>
        
<h3 class="mt-5">User Reviews</h3>
        
@using Microsoft.EntityFrameworkCore
@using Microsoft.IdentityModel.Tokens
@{
    var reviews = _db.Reviews
        .Where(r => r.MediaId == mediaId && r.MediaType == mediaType)
        .Include(r => r.User)
        .OrderByDescending(r => r.CreatedAt)
        .ToList();
}

@foreach (var rev in reviews)
{
    <div class="card mt-3">
        <div class="card-body">

            <a asp-controller="Profile"
               asp-action="Index"
               asp-route-id="@rev.UserId"
               style="text-decoration:none;">
                <strong>@rev.User.UserName</strong>
            </a>
            <p>@rev.Content</p>
            
            <small class="text-muted">
                Posted @rev.CreatedAt.ToLocalTime().ToString("g")
            </small>
            
            @{
                var existing = _db.Likes
                    .FirstOrDefault(l => l.UserId == userId && l.ReviewId == rev.Id);
                var isLiked = existing != null;
                
                var likes = _db.Likes
                    .Where(l => l.ReviewId == rev.Id).ToList();
            }
            <br/>
            <button type="button"
                    class="btn btn-sm review-like-btn @(isLiked ? "btn-danger text-white" : "btn-outline-primary")"
                    data-review-id="@rev.Id">

                ❤️ Like (@likes.Count)
            </button>
            
            @if (User.Identity.IsAuthenticated && 
                 int.Parse(User.FindFirst("UserId")!.Value) == rev.UserId)
            {
                <form method="post" action="/Activity/DeleteReview" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="reviewId" value="@rev.Id" />
                    <button class="btn btn-sm btn-danger">Delete</button>
                </form>
            }

        </div>
    </div>
}

<script>
document.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll(".review-like-btn").forEach(btn => {
        btn.addEventListener("click", () => {

            let reviewId = btn.dataset.reviewId;

            fetch("/Activity/ToggleReviewLikeAjax", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ reviewId: reviewId })
            })
            .then(res => res.json())
            .then(data => {

                if (!data.success) return;

                // renk değiştir
                if (data.isLiked) {
                    btn.classList.remove("btn-outline-primary");
                    btn.classList.add("btn-danger", "text-white");
                }
                else {
                    btn.classList.add("btn-outline-primary");
                    btn.classList.remove("btn-danger", "text-white");
                }

                // like sayısını güncelle
                btn.innerHTML = `❤️ Like (${data.likeCount})`;
            });
        });
    });

});
</script>