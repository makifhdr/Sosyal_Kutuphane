@using Microsoft.IdentityModel.Tokens
@model Sosyal_Kutuphane.Models.ViewModels.ExploreViewModel

<div class="container mt-4">

    <h1>Search</h1>

    <form method="get" asp-controller="Search" asp-action="AdvancedSearch" class="row g-3 mb-5">

        <div class="col-md-6">
            <label class="form-label">Search</label>
            <input type="text" name="query" class="form-control" placeholder="Search for movies or books..." required />
        </div>

        <div class="col-md-3">
            <label class="form-label">Type</label>
            <select name="type" id="typeSelect" class="form-select">
                <option value="movie">Movies</option>
                <option value="book">Books</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Genre</label>
            <select name="genre" id="genreSelect" class="form-select">
                <option value="">Any</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Year</label>
            <input type="number" name="year" class="form-control" min="1900" max="2100" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Min Rating</label>
            <select name="minRating" class="form-select">
                <option value="">Any</option>
                <option value="2">2+</option>
                <option value="4">4+</option>
                <option value="6">6+</option>
                <option value="7">7+</option>
                <option value="8">8+</option>
            </select>
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100">Search & Apply Filters</button>
        </div>
    </form>

    <hr />

    <h2 class="mt-5">Top Rated</h2>
    <div class="row mt-3">
        @{
            var topRated = Model.TopRated;
        }
        
        @if (!topRated.IsNullOrEmpty())
        {
            foreach (var item in topRated)
                {
                    <div class="col-md-3 mb-4">
                        <div class="card shadow-sm h-100">
                            <img src="@item.PosterUrl" class="card-img-top" alt="Image couldn't be displayed"/>

                            <div class="card-body">
                                <strong>@item.Title (@(item.MediaType == "book" ? "Book" : "Movie"))</strong><br/>
                                <small>⭐ @item.AverageRating/10 (@item.RatingCount ratings)</small>
                            </div>

                            <div class="card-footer bg-white border-0">
                                <a class="btn btn-primary w-100"
                                   href="/Media/@(item.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@item.MediaId">
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
        }
        else
        {
            <div class="text-center text-muted mt-3">
                No item found.
            </div>
        }
    </div>

    <h2 class="mt-5">Most Popular</h2>
    <div class="row mt-3">
        @{
            var mostPopular = Model.MostPopular;
        }
        
        @if (mostPopular.Count != 0)
        {
            @foreach (var item in Model.MostPopular)
            {
                <div class="col-md-3 mb-4">
                    <div class="card shadow-sm h-100">
                        <img src="@item.PosterUrl" class="card-img-top" alt="Image couldn't be displayed"/>

                        <div class="card-body">
                            <strong>@item.Title</strong><br/>
                            <small>🔥 Popularity: @item.PopularityScore</small>
                        </div>

                        <div class="card-footer bg-white border-0">
                            <a class="btn btn-outline-primary w-100"
                               href="/Media/@(item.MediaType == "movie" ? "MovieDetails" : "BookDetails")/@item.MediaId">
                                View
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted mt-3">
                No item found.
            </div>
        }
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const typeSelect = document.getElementById("typeSelect");
    const genreSelect = document.getElementById("genreSelect");

    const movieGenres = [
        { id: "28", name: "Action" },
        { id: "12", name: "Adventure" },
        { id: "16", name: "Animation" },
        { id: "35", name: "Comedy" },
        { id: "80", name: "Crime" },
        { id: "18", name: "Drama" },
        { id: "14", name: "Fantasy" },
        { id: "27", name: "Horror" },
        { id: "10749", name: "Romance" },
        { id: "878", name: "Sci-Fi" }
    ];

    const bookGenres = [
        "Fiction",
        "Science Fiction",
        "Fantasy",
        "Romance",
        "Thriller",
        "Horror",
        "Mystery",
        "Biography",
        "History",
        "Children",
        "Young Adult",
        "Collectibles",
        "Business",
        "Technology",
        "Engineering",
        "Design"
    ];

    function updateGenres() {
        let type = typeSelect.value;
        genreSelect.innerHTML = "";

        let defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Any";
        genreSelect.appendChild(defaultOption);

        if (type === "movie") {

            movieGenres.forEach(g => {
                let opt = document.createElement("option");
                opt.value = g.id;
                opt.textContent = g.name;
                genreSelect.appendChild(opt);
            });

        } else if (type === "book") {

            bookGenres.forEach(name => {
                let opt = document.createElement("option");
                opt.value = name.toLowerCase();
                opt.textContent = name;
                genreSelect.appendChild(opt);
            });

        }
    }

    updateGenres();

    typeSelect.addEventListener("change", updateGenres);

});
</script>
