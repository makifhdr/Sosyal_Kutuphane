@using Microsoft.IdentityModel.Tokens
@model Sosyal_Kutuphane.Models.User

@{
    bool isOwner = ViewBag.IsOwner;
    bool isFollowing = ViewBag.IsFollowing;
    var reviews = ViewBag.RecentReviews;
    var ratings = ViewBag.RecentRatings;

    string avatar = Model.Avatar != null 
        ? $"data:image/png;base64,{Convert.ToBase64String(Model.Avatar)}"
        : "/default-avatar.jpg";
    var bio = Model.Bio.IsNullOrEmpty() ? "No biography has been written." : Model.Bio;
}

<div class="container mt-4">

    <div class="d-flex align-items-center">
        <img src="@avatar"
             width="120" height="120"
             class="rounded-circle border" 
             alt="Image couldn't be displayed"/>

        <div class="ms-4">
            <h2>@Model.UserName</h2>
            <p class="text-muted">@bio</p>

            @if (isOwner)
            {
                <a class="btn btn-secondary" asp-action="Edit">Edit Profile</a>
                <a class="btn btn-primary" asp-action="CreateList">New Custom List</a>
            }
            else
            {
                <form method="post" asp-action="ToggleFollow">
                    <input type="hidden" name="targetUserId" value="@Model.Id" />
                    <button class="btn btn-@(isFollowing ? "danger" : "success")">
                        @(isFollowing ? "Unfollow" : "Follow")
                    </button>
                </form>
            }
        </div>
    </div>

    <hr />

    <ul class="nav nav-tabs mt-4" id="profileTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#watched">Watched</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#towatch">To Watch</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#read">Read</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#toread">To Read</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#custom">Custom Lists</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#activity">Recent Activity</a></li>
    </ul>

    <div class="tab-content mt-3">

        <div class="tab-pane fade show active" id="watched">
            @await Component.InvokeAsync("UserMediaList", new { userId = Model.Id, status = "watched" })
        </div>

        <div class="tab-pane fade" id="towatch">
            @await Component.InvokeAsync("UserMediaList", new { userId = Model.Id, status = "towatch" })
        </div>

        <div class="tab-pane fade" id="read">
            @await Component.InvokeAsync("UserMediaList", new { userId = Model.Id, status = "read" })
        </div>

        <div class="tab-pane fade" id="toread">
            @await Component.InvokeAsync("UserMediaList", new { userId = Model.Id, status = "toread" })
        </div>

        <div class="tab-pane fade" id="custom">
            @if (Model.CustomLists.Count != 0)
            {
                foreach (var list in Model.CustomLists)
                {
                    <div class="card p-3 mt-3">
                        <h4>@list.Name</h4>
                        <a class="btn btn-outline-primary mt-2" href="/CustomList/Details/@list.Id">View List</a>
                    </div>
                }
            }
            else
            {
                <div class="text-muted">No custom lists found.</div>
            }
        </div>

        <div class="tab-pane fade" id="activity">
            <h4>User Activity</h4>

            <h5 class="mt-4">Recent Ratings</h5>
            @{
                if (ratings.Length == 0)
                {
                    <div class="text-muted">No recent ratings found.</div>
                }
                else
                {
                    foreach (var r in ratings)
                    {
                        var href = r.MediaType == "movie" ? $"/Media/MovieDetails/{r.MediaId}" :
                            $"/Media/BookDetails/{r.MediaId}" ;
                        var type = r.MediaType == "movie" ? "Movie" : "Book";
                        <div 
                            class="card p-3 mt-3">
                            <a href="@href" class="text-decoration-none">@r.Title</a>
                            <dd><strong>Type: </strong> @type</dd>
                            <div>Rated: @r.Score / 10</div>
                            <div class="text-muted">@Sosyal_Kutuphane.Helpers.TimeAgo.Format(r.CreatedAt)</div>
                        </div>
                    }
                }
            }

            <h5 class="mt-4">Recent Reviews</h5>
            
            @{
                if (reviews.Length == 0)
                {
                    <div class="text-muted">No recent reviews found.</div>
                }
                else
                {
                    foreach (var r in reviews)
                    {
                        var href = r.MediaType == "movie" ? $"/Media/MovieDetails/{r.MediaId}" :
                            $"/Media/BookDetails/{r.MediaId}" ;
                        var type = r.MediaType == "movie" ? "Movie" : "Book";
                        <div class="card p-3 mt-3">

                            <a href="@href" class="text-decoration-none">@r.Title</a>
                            <dd><strong>Type: </strong> @type</dd>
                            <p>@r.Content</p>

                            <div class="text-muted">
                                @Sosyal_Kutuphane.Helpers.TimeAgo.Format(r.CreatedAt)
                            </div>

                        </div>
                    }
                }
            }
        </div>

    </div>

</div>
